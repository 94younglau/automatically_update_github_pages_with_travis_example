<h1 id="automatically-update-github-pages-with-travis">Automatically Update Github Pages with Travis</h1>
<p><a href="https://travis-ci.org/steveklabnik/automatically_update_github_pages_with_travis_example"><img src="https://travis-ci.org/steveklabnik/automatically_update_github_pages_with_travis_example.svg?branch=master" alt="Build Status" /></a></p>
<p>Do you want to update Github Pages automatically, and use Travis CI? You've come to the right place.</p>
<p>Both versions:</p>
<ul>
<li><a href="http://steveklabnik.github.io/automatically_update_github_pages_with_travis_example/">rendered</a></li>
<li><a href="https://github.com/steveklabnik/automatically_update_github_pages_with_travis_example">source</a></li>
</ul>
<h1 id="the-problem">The problem</h1>
<p>Here's a few things, which when combined, cause a problem.</p>
<ol style="list-style-type: decimal">
<li>Checking in generated files is considered poor practice.</li>
<li>Often, web pages aren't in HTML directly: they're generated from some other file.</li>
<li><code>master</code> is the default branch of <code>git</code> repositories.</li>
<li><code>gh-pages</code> is the default branch for Github Pages.</li>
</ol>
<p>Our source files end up on one branch, but we need to move the generated files to another branch. And of course, we don't want to just do this on every build, but on successful CI builds of master. Whew!</p>
<h1 id="the-solution">The solution</h1>
<p>Follow these steps.</p>
<h2 id="ensure-you-have-gh-pages">Ensure you have <code>gh-pages</code></h2>
<p>You want to make sure your branch already exists.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">git</span> checkout master
$ <span class="kw">git</span> checkout -b --orphan gh-pages
$ <span class="kw">git</span> push origin -u gh-pages
$ <span class="kw">git</span> checkout master</code></pre></div>
<p>Easy enough.</p>
<h2 id="find-out-your-github-api-token">Find out your Github API token</h2>
<p>Click <a href="https://github.com/settings/tokens/new">this link</a> to generate a new Personal access token. You might need to re-enter your password.</p>
<p>You'll need to check some boxes. Check these ones:</p>
<div class="figure">
<img src="img/token.png" alt="github token setting" />
<p class="caption">github token setting</p>
</div>
<p>That's right, just <code>repo</code>. If your repository is public, you can set <code>public_repo</code> instead.</p>
<p>GitHub will create the token, and show you a flash with the value.</p>
<p><strong>THIS IS THE ONLY TIME YOU GET TO SEE THIS SO DON'T CLICK AWAY IMMEDIATELY!</strong></p>
<p>You'll need to copy this token into someplace you trust. I wrote mine down, so I could just light the paper on fire afterward. :wink:. It'll never be shown to you after this time, so it's important to double-check your work.</p>
<h2 id="set-up-travis">Set up Travis</h2>
<p>There are multiple ways to do this.</p>
<h3 id="set-the-variables-on-the-travis-ci-dashboard">Set the variables on the Travis-CI dashboard</h3>
<ul>
<li>Go to the settings page of your repository on https://travis-ci.org/</li>
<li>In the Environment Variables section set a variable with the name of <code>GH_TOKEN</code> and the value of your personal access token.</li>
</ul>
<h3 id="set-the-variables-in-the-.travis.yml-file">Set the variables in the .travis.yml file</h3>
<p><em>With Node.js and Python 3.x installed:</em></p>
<p>´´´bash $ npm install travis-encrypt -g $ travis-encrypt -r username/repository -k GH_TOKEN -v [the token you created before] ´´´</p>
<p><em>With Ruby installed:</em></p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">gem</span> install travis
$   <span class="kw">travis</span> encrypt -r username/reponame GH_TOKEN=[the token you created before] --add</code></pre></div>
<p>Note: that I put some spaces before the <code>travis</code> command. If you have <code>bash</code> configured in this common way, this makes sure the command doesn't end up in your Bash History. Can't be too safe with those tokens.</p>
<p>Note: You'll need to have enabled travis for your repo before this.</p>
<p>Check out <a href="http://docs.travis-ci.com/user/encryption-keys/">this page</a> to read more about variable encryption in Travis.</p>
<h2 id="edit-your-.travis.yml">Edit your .travis.yml</h2>
<p>Here's what this should look like:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">language:</span> something
<span class="fu">install:</span>
  <span class="kw">-</span> npm install
<span class="fu">script:</span>
  <span class="kw">-</span> make check
  <span class="kw">-</span> make generate
<span class="fu">after_success:</span>
  <span class="kw">-</span> bash deploy.sh
<span class="fu">env:</span>
  <span class="fu">global:</span>
    <span class="kw">-</span> <span class="fu">secure:</span> <span class="st">&quot;oFD/tic8JAwpMXuMDBZXV4ot6w1NLWvHQnrDKmUHSMQJC1cbbrR1p5q8XayfjtmdqQdFQmIfM6YHEKeHw//ypgObWjYS8q00OaaMDXPTdmgr1Ee4nhgkkDihT+kVij0rn96W/QvyAVoaV5hJoyUr3Nhk+mnHEYm3M+Q3LAQglRg=&quot;</span></code></pre></div>
<p>Let's go over this, line by line:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">language:</span> something</code></pre></div>
<p>This should be set to whatever the language is of your project. What happens if your project's build tool is different than your project itself? You may need to add an <code>install</code> line to install the other tools. Like for example things listed in package.json.</p>
<p>This should look something like this if you use Node.js:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">language:</span> node_js
<span class="fu">node_js:</span>
  <span class="kw">-</span> <span class="st">&quot;4.1&quot;</span>
<span class="fu">install:</span>
  <span class="kw">-</span> npm install</code></pre></div>
<p>Next, our actual build:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">script:</span>
  <span class="kw">-</span> make check
  <span class="kw">-</span> make generate</code></pre></div>
<p>This changes based on whatever your build actually is. I show this section because you will generally want to run more than one command: one to run the tests one to build your project, and one to build the actual documentation.</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">after_success:</span>
  <span class="kw">-</span> bash deploy.sh</code></pre></div>
<p>Ok so now we have a successful build so we want to start the deploy. Note that we can have a different approach:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">after_success:</span>
  <span class="kw">-</span> test $TRAVIS_PULL_REQUEST == <span class="st">&quot;false&quot;</span> &amp;&amp; test $TRAVIS_BRANCH == <span class="st">&quot;master&quot;</span> &amp;&amp; bash deploy.sh</code></pre></div>
<p>Here we want to check out where we are. We only want to update Github Pages if we're building the master branch of the original repository, so we have to check <code>$TRAVIS_PULL_REQUEST</code> and <code>$TRAVIS_BRANCH</code>.</p>
<p>If we are here, we run <code>bash deploy.sh</code>. What's the contents of <code>deploy.sh</code>? We'll talk about that in a moment. We have one more line to cover:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">env:</span>
  <span class="fu">global:</span>
    <span class="kw">-</span> <span class="fu">secure:</span> <span class="st">&quot;oFD/tic8JAwpMXuMDBZXV4ot6w1NLWvHQnrDKmUHSMQJC1cbbrR1p5q8XayfjtmdqQdFQmIfM6YHEKeHw//ypgObWjYS8q00OaaMDXPTdmgr1Ee4nhgkkDihT+kVij0rn96W/QvyAVoaV5hJoyUr3Nhk+mnHEYm3M+Q3LAQglRg=&quot;</span></code></pre></div>
<p>This, of course, should use the value from <code>travis encrypt</code> from before. Remember how we encrypted <code>GH_TOKEN=...</code> before? This will ensure that our <code>GH_TOKEN</code> variable is set to the unencrypted value. That sounds scary, but Travis will <em>not</em> set this on forks or pull requests, so that someone can't just submit a PR that <code>echo</code>es the value out.</p>
<h2 id="set-up-deploy-script">Set up deploy script</h2>
<p>Okay, next, we need to add a <code>deploy.sh</code> to our repository. You'll need to tweak this slightly for your setup, but here's the basic idea:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">#!/bin/bash</span>

<span class="kw">set</span> <span class="kw">-o</span> errexit -o nounset

<span class="kw">if [</span> <span class="st">&quot;</span><span class="ot">$TRAVIS_BRANCH</span><span class="st">&quot;</span> <span class="ot">!=</span> <span class="st">&quot;master&quot;</span><span class="kw"> ]</span>
<span class="kw">then</span>
  <span class="kw">echo</span> <span class="st">&quot;This commit was made against the </span><span class="ot">$TRAVIS_BRANCH</span><span class="st"> and not the master! No deploy!&quot;</span>
  <span class="kw">exit</span> 0
<span class="kw">fi</span>

<span class="ot">rev=$(</span><span class="kw">git</span> rev-parse --short HEAD<span class="ot">)</span>

<span class="kw">cd</span> stage/_book

<span class="kw">git</span> init
<span class="kw">git</span> config user.name <span class="st">&quot;Steve Klabnik&quot;</span>
<span class="kw">git</span> config user.email <span class="st">&quot;steve@steveklabnik.com&quot;</span>

<span class="kw">git</span> remote add upstream <span class="st">&quot;https://</span><span class="ot">$GH_TOKEN</span><span class="st">@github.com/rust-lang/rust-by-example.git&quot;</span>
<span class="kw">git</span> fetch upstream
<span class="kw">git</span> reset upstream/gh-pages

<span class="kw">echo</span> <span class="st">&quot;rustbyexample.com&quot;</span> <span class="kw">&gt;</span> CNAME

<span class="kw">touch</span> .

<span class="kw">git</span> add -A .
<span class="kw">git</span> commit -m <span class="st">&quot;rebuild pages at </span><span class="ot">${rev}</span><span class="st">&quot;</span>
<span class="kw">git</span> push -q upstream HEAD:gh-pages</code></pre></div>
<p>Let's do it, paragraph by paragraph:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">#!/bin/bash</span></code></pre></div>
<p>The standard shebang line. We don't really need to set this, as we execute it with <code>bash deploy.sh</code>, but I like to put it in anyway.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">set</span> <span class="kw">-o</span> errexit -o nounset</code></pre></div>
<p>This sets two options for the shell to make the script more reliable:</p>
<ul>
<li><code>errexit</code>: stop executing if any errors occur, by default bash will just continue past any errors to run the next command</li>
<li><code>nounset</code>: stop executing if an unset variable is encountered, by default bash will use an empty string for the value of such variables.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">if [</span> <span class="st">&quot;</span><span class="ot">$TRAVIS_BRANCH</span><span class="st">&quot;</span> <span class="ot">!=</span> <span class="st">&quot;master&quot;</span><span class="kw"> ]</span>
<span class="kw">then</span>
  <span class="kw">echo</span> <span class="st">&quot;This commit was made against the </span><span class="ot">$TRAVIS_BRANCH</span><span class="st"> and not the master! No deploy!&quot;</span>
  <span class="kw">exit</span> 0
<span class="kw">fi</span></code></pre></div>
<p>Here we ensure that we only deploy when we commit against the master branch, if not we just simply abort the deploy, no errors. So this way we can see the result of the tests when we make pull request between different branches or commit against a different branch than the master.</p>
<p>Note: This only works if in .travis.yml we used the unconditional deploy.</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">after_success:</span>
  <span class="kw">-</span> bash deploy.sh</code></pre></div>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ot">rev=$(</span><span class="kw">git</span> rev-parse --short HEAD<span class="ot">)</span></code></pre></div>
<p>This sets a variable, <code>rev</code>, with the short hash of <code>HEAD</code>. We'll use this later in a commit message.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> _book</code></pre></div>
<p>We need to <code>cd</code> into wherever our website built. With Jekyll, it's <code>_site</code>. But do whatever.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">git</span> init
<span class="kw">git</span> config user.name <span class="st">&quot;Steve Klabnik&quot;</span>
<span class="kw">git</span> config user.email <span class="st">&quot;steve@steveklabnik.com&quot;</span></code></pre></div>
<p>First, we initialize a new <code>git</code> repository. Yes, a new one. You'll see.</p>
<p>We then set our user name and user email. This person will have done the commits that go to <code>gh-pages</code>. It's not a default branch, so don't worry, GitHub doesn't count these commits as contributions for your graph.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">git</span> remote add upstream <span class="st">&quot;https://</span><span class="ot">$GH_TOKEN</span><span class="st">@github.com/me/project.git&quot;</span>
<span class="kw">git</span> fetch upstream
<span class="kw">git</span> reset upstream/gh-pages</code></pre></div>
<p>Next, we add a remote, named <code>upstream</code>, and we set it to our project. But we also interpolate that <code>$GH_TOKEN</code> variable, which will allow us to push to this repository later.</p>
<p>We then <code>fetch</code> it and <code>reset</code> to the <code>gh-pages</code> branch. Now, <code>git</code> sees this new repository as just some files that change your upstream <code>gh-pages</code> branch.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">echo</span> <span class="st">&quot;myproject.com&quot;</span> <span class="kw">&gt;</span> CNAME</code></pre></div>
<p>Sometimes, you'll need some extra files. A <code>CNAME</code> is common, which sets a custom domain up. You'll need to run whatever commands generate those files for you.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">touch</span> .</code></pre></div>
<p>We then <code>touch</code> everything, so that <code>git</code> considers all of our local copies fresh.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">git</span> add -A .
<span class="kw">git</span> commit -m <span class="st">&quot;rebuild pages at </span><span class="ot">${rev}</span><span class="st">&quot;</span>
<span class="kw">git</span> push -q upstream HEAD:gh-pages</code></pre></div>
<p>We then add all changes, commit them, using our <code>rev</code> from earlier, and then push to <code>upstream</code>. The <code>-q</code> keeps this a bit more quiet, and you can control the noisiness of all these different <code>git</code> commands with a judicious sprinkling of <code>-q</code>.</p>
<h2 id="success">Success!</h2>
<p>That's it! Commit this all, and push. Travis should now do its magic, and everything will update!</p>
<h2 id="one-drawback">One Drawback</h2>
<p>One drawback of this is that if you have a build matrix that builds your project with multiple versions of your platform, you'll end up with the same number of pages builds. Which seems redundant.</p>
<p>I <em>think</em> I could take advantage of Travis' &quot;deploy&quot; feature to fix this, but I'm not sure how.</p>
<h2 id="feedback-please">Feedback please</h2>
<p>I'd love to know if there's a better way to do any of this. In particular, I'd love to add the local git repo rather than the one from GitHub when fetching the <code>upstream</code>, but since Travis checks out a bare repository, it doesn't seem possible. Please <a href="https://github.com/steveklabnik/automatically_update_github_pages_with_travis_example/issues/new">open an issue</a> or PR to show me how to do it better!</p>
